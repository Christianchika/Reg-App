<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Register - Registration App</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav class="navbar">
    <div class="container">
        <a href="/" class="navbar-brand">üìù Registration App</a>
        <ul class="navbar-nav">
            <li><a href="/" class="nav-link">Home</a></li>
            <li><a href="/register" class="nav-link">Register</a></li>
            <li><a href="/login" class="nav-link">Login</a></li>
            <li><a href="/dashboard" class="nav-link">Dashboard</a></li>
        </ul>
    </div>
</nav>

<div class="container" style="max-width: 500px; margin-top: 3rem;">
    <div class="card">
        <div class="card-header">
            <h2>Create Account</h2>
            <p>Join us today! It only takes a minute.</p>
        </div>

        <div id="alert" class="alert" style="display:none;"></div>

        <form id="registerForm">
            <div class="form-group">
                <label for="fullname">Full Name</label>
                <input type="text" id="fullname" name="fullname" class="form-control" required>
                <div id="fullname-error" class="form-error"></div>
            </div>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" class="form-control" required>
                <div id="username-error" class="form-error"></div>
            </div>
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" class="form-control" required>
                <div id="email-error" class="form-error"></div>
            </div>
            <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" name="phone" class="form-control">
                <div id="phone-error" class="form-error"></div>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" class="form-control" required>
                <div id="password-error" class="form-error"></div>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" required>
                <div id="confirmPassword-error" class="form-error"></div>
            </div>
            <button type="submit" class="btn btn-primary" id="submitBtn">Create Account</button>
        </form>

        <p class="text-center mt-3">
            Already have an account? <a href="/login">Sign In</a>
        </p>
    </div>
</div>

<script>
/* --------------------- API Request --------------------- */
async function apiRequest(endpoint, options = {}) {
    const res = await fetch(`/api${endpoint}`, {
        headers: { 'Content-Type': 'application/json' },
        ...options
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'API request failed');
    return data;
}

/* --------------------- Validation --------------------- */
function isValidEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
function isValidUsername(username) { return /^[a-zA-Z0-9_]{3,50}$/.test(username); }
function isValidPassword(password) { return /^(?=.*\d).{6,}$/.test(password); }

/* --------------------- Error & Alert --------------------- */
function showFormError(id, msg) { document.getElementById(id+'-error').textContent = msg; }
function clearFormError(id) { document.getElementById(id+'-error').textContent = ''; }
function clearAllFormErrors() {
    ['fullname','username','email','phone','password','confirmPassword'].forEach(clearFormError);
}
function showAlert(msg, type='success') {
    const alert = document.getElementById('alert');
    alert.textContent = msg;
    alert.className = `alert alert-${type}`;
    alert.style.display = 'block';
}
function hideAlert() { document.getElementById('alert').style.display = 'none'; }
function showLoading(btn) { btn.disabled = true; btn.textContent = 'Please wait...'; }
function hideLoading(btn) { btn.disabled = false; btn.textContent = 'Create Account'; }

/* --------------------- Form Submission --------------------- */
const form = document.getElementById('registerForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearAllFormErrors(); hideAlert();

    const fullname = document.getElementById('fullname').value.trim();
    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    let hasError = false;
    if (!fullname || fullname.length < 2) { showFormError('fullname','Full name must be at least 2 characters'); hasError = true; }
    if (!isValidUsername(username)) { showFormError('username','Username 3-50 chars, letters/numbers/_ only'); hasError = true; }
    if (!isValidEmail(email)) { showFormError('email','Invalid email'); hasError = true; }
    if (!isValidPassword(password)) { showFormError('password','Password min 6 chars with a number'); hasError = true; }
    if (password !== confirmPassword) { showFormError('confirmPassword','Passwords do not match'); hasError = true; }
    if (hasError) return;

    const btn = document.getElementById('submitBtn'); showLoading(btn);

    try {
        await apiRequest('/users/register', { method: 'POST', body: JSON.stringify({ fullname, username, email, phone: phone || null, password }) });
        showAlert('Account created! Redirecting to login...', 'success');
        form.reset();
        setTimeout(()=>{ window.location.href='/login'; }, 2000);
    } catch (err) {
        if (err.message.includes('Email')) showFormError('email', err.message);
        else if (err.message.includes('Username')) showFormError('username', err.message);
        else showAlert(err.message || 'Registration failed', 'error');
    } finally { hideLoading(btn); }
});
</script>
</body>
</html>
