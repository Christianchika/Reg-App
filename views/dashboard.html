<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Registration App</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="/" class="navbar-brand">üìù Registration App</a>
            <ul class="navbar-nav">
                <li><a href="/" class="nav-link">Home</a></li>
                <li><a href="/register" class="nav-link">Register</a></li>
                <li><a href="/login" class="nav-link">Login</a></li>
                <li><a href="/dashboard" class="nav-link">Dashboard</a></li>
            </ul>
        </div>
    </nav>

    <!-- Dashboard -->
    <div class="container" style="margin-top: 2rem;">
        <!-- User Info -->
        <div class="card" id="userInfoCard" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3>Welcome, <span id="userName"></span>! üëã</h3>
                    <p style="color: var(--gray); margin-top: 0.5rem;">
                        Email: <span id="userEmail"></span>
                    </p>
                </div>
                <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="totalUsers">0</h3>
                <p>Total Registered Users</p>
            </div>
            <div class="stat-card">
                <h3 id="recentUsers">0</h3>
                <p>New Users (Last 7 Days)</p>
            </div>
            <div class="stat-card">
                <h3 id="activeUsers">0</h3>
                <p>Active Users (Last Login)</p>
            </div>
        </div>

        <!-- Users Table -->
        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 class="card-title">Registered Users</h2>
                    <p class="card-subtitle">All users in the system</p>
                </div>
                <button onclick="loadUsers()" class="btn btn-primary btn-sm">
                    üîÑ Refresh
                </button>
            </div>

            <!-- Alert -->
            <div id="alert" class="alert"></div>

            <!-- Loading -->
            <div id="loading" class="hidden">
                <div class="spinner"></div>
                <p class="loading-text">Loading users...</p>
            </div>

            <!-- Table -->
            <div id="tableContainer" class="table-container hidden">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Registered</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden" style="text-align: center; padding: 3rem;">
                <h3 style="color: var(--gray);">No users found</h3>
                <p style="color: var(--gray); margin-top: 0.5rem;">Be the first to register!</p>
                <a href="/register" class="btn btn-primary mt-2">Register Now</a>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        let allUsers = [];

        // Display current user info
        function displayUserInfo() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = user.fullname || user.username;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userInfoCard').style.display = 'block';
            }
        }

        // Load all users
        async function loadUsers() {
            const loading = document.getElementById('loading');
            const tableContainer = document.getElementById('tableContainer');
            const emptyState = document.getElementById('emptyState');
            const tbody = document.getElementById('usersTableBody');

            // Show loading
            loading.classList.remove('hidden');
            tableContainer.classList.add('hidden');
            emptyState.classList.add('hidden');
            hideAlert();

            try {
                const data = await apiRequest('/users');
                allUsers = data.data;

                if (allUsers.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    // Display users
                    tbody.innerHTML = allUsers.map(user => `
                        <tr>
                            <td>${user.user_id}</td>
                            <td>
                                <strong>${user.username}</strong>
                                ${user.user_id === getCurrentUser()?.user_id ? '<span class="badge badge-info">You</span>' : ''}
                            </td>
                            <td>${user.fullname || '-'}</td>
                            <td>${user.email}</td>
                            <td>${user.phone || '-'}</td>
                            <td>${formatDate(user.created_at)}</td>
                            <td>${user.last_login ? formatDate(user.last_login) : '<span class="badge badge-info">Never</span>'}</td>
                            <td>
                                <button 
                                    onclick="viewUser(${user.user_id})" 
                                    class="btn btn-sm btn-secondary"
                                    style="margin-right: 0.5rem;">
                                    View
                                </button>
                                <button 
                                    onclick="deleteUser(${user.user_id}, '${user.username}')" 
                                    class="btn btn-sm btn-danger">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    
                    tableContainer.classList.remove('hidden');
                    updateStats();
                }

            } catch (error) {
                showAlert('Failed to load users: ' + error.message, 'error');
                emptyState.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Update statistics
        function updateStats() {
            const total = allUsers.length;
            document.getElementById('totalUsers').textContent = total;

            // Recent users (last 7 days)
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recent = allUsers.filter(user => new Date(user.created_at) > sevenDaysAgo).length;
            document.getElementById('recentUsers').textContent = recent;

            // Active users (logged in at least once)
            const active = allUsers.filter(user => user.last_login !== null).length;
            document.getElementById('activeUsers').textContent = active;
        }

        // View user details
        async function viewUser(userId) {
            try {
                const data = await apiRequest(`/users/${userId}`);
                const user = data.data;

                alert(`
User Details:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
ID: ${user.user_id}
Username: ${user.username}
Full Name: ${user.fullname}
Email: ${user.email}
Phone: ${user.phone || 'Not provided'}
Registered: ${formatDate(user.created_at)}
Last Login: ${user.last_login ? formatDate(user.last_login) : 'Never'}
                `.trim());

            } catch (error) {
                showAlert('Failed to load user details: ' + error.message, 'error');
            }
        }

        // Delete user
        async function deleteUser(userId, username) {
            const currentUser = getCurrentUser();
            
            if (currentUser && currentUser.user_id === userId) {
                showAlert('You cannot delete your own account from here!', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete user "${username}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                await apiRequest(`/users/${userId}`, {
                    method: 'DELETE'
                });

                showAlert(`User "${username}" has been deleted successfully.`, 'success');
                loadUsers(); // Reload the list

            } catch (error) {
                showAlert('Failed to delete user: ' + error.message, 'error');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            displayUserInfo();
            loadUsers();
        });
    </script>
</body>
</html>